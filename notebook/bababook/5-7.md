## 7-1.この章で使うパッケージ

``` r
library(dlm)   # カルマンフィルタを用いて状態空間モデルを推定
library(KFAS)  # 散漫カルマンフィルタを用いて状態空間モデルを推定
library(ggplot2)
library(ggfortify)
```

## 7-2.分析の対象

-   ナイル川の流量データ
-   1年に1回だけ観測され、1871〜1970年の100年間分。

``` r
# データ
Nile
```

    ## Time Series:
    ## Start = 1871 
    ## End = 1970 
    ## Frequency = 1 
    ##   [1] 1120 1160  963 1210 1160 1160  813 1230 1370 1140  995  935 1110  994 1020
    ##  [16]  960 1180  799  958 1140 1100 1210 1150 1250 1260 1220 1030 1100  774  840
    ##  [31]  874  694  940  833  701  916  692 1020 1050  969  831  726  456  824  702
    ##  [46] 1120 1100  832  764  821  768  845  864  862  698  845  744  796 1040  759
    ##  [61]  781  865  845  944  984  897  822 1010  771  676  649  846  812  742  801
    ##  [76] 1040  860  874  848  890  744  749  838 1050  918  986  797  923  975  815
    ##  [91] 1020  906  901 1170  912  746  919  718  714  740

``` r
# サンプルサイズ
length(Nile)
```

    ## [1] 100

## 7-3.Rで実装するカルマンフィルタ：関数を作る

-   「予測」と「フィルタリング」を行う関数を作成

``` r
# Rで実装するカルマンフィルタ:関数を作る --------------------

kfLocalLevel <- function(y, mu_pre, P_pre, sigma_w, sigma_v) {
  ## Step1 予測
  # 状態の予測(ローカルレベルモデルなので、予測値は、前期の値と同じ)
  mu_forecast <- mu_pre
  
  # 状態の予測誤差の分散(過程誤差の分散だけ増える)
  P_forecast <- P_pre + sigma_w
  
  # 観測値の予測(ローカルレベルモデルなので、状態の予測値と同じ)
  y_forecast <- mu_forecast
  
  # 観測値の予測誤差の分散(状態の分散に加えて、観測誤差の分散だけ増える)
  F <- P_forecast + sigma_v
  
  ## Step2 フィルタリング(状態の補正)
  # カルマンゲイン( P_forecast/F としても同じです)
  K <- P_forecast / (P_forecast + sigma_v)
  
  # 観測値の予測残差
  y_resid <- y - y_forecast
  
  # カルマンゲインを使って状態を補正
  mu_filter <- mu_forecast + K * y_resid
  
  # 補正された状態の誤差の分散
  P_filter <- (1 - K) * P_forecast
  
  # 結果の格納
  result <- data.frame(
    mu_filter = mu_filter, 
    P_filter = P_filter,
    y_resid = y_resid,
    F = F,
    K = K
  )
  
  return(result)
}
```

## 7-4.Rで実装するカルマンフィルタ：状態を推定する

-   上記で作成した関数を時点をずらしながら何度も実行することで、フィルタ化推定量を求めることが可能。

``` r
# サンプルサイズ
N <- length(Nile)

# 状態の推定値
mu_filter <- numeric(N)

# 「状態」の初期値は0とします
mu_zero <- 0
mu_filter <- c(mu_zero, mu_filter)

# 状態の予測誤差の分散
P_filter <- numeric(N)

# 「状態の予測誤差の分散」の初期値は10000000にします
P_zero <- 10000000
P_filter <- c(P_zero, P_filter)

# 観測値の予測残差
y_resid <- numeric(N)

# 観測値の予測誤差の分散
F <- numeric(N)

# カルマンゲイン
K <- numeric(N)

# 過程誤差の分散
sigma_w <- 1000

# 観測誤差の分散
sigma_v <- 10000
```

-   この時、フィルタ化推定量やその分散については、配列の長さが *N* + 1
    となっていることに注意。

-   これは、初期値を与える関係で発生する。初期値が必要のない観測値等は
    *N* のまま。

-   kfLocalLevel関数を用いて、最尤法を実践していく。

``` r
# カルマンフィルタの逐次計算を行う
for(i in 1:N) {
  kekka <- kfLocalLevel(
    y = Nile[i], mu_pre = mu_filter[i], P_pre = P_filter[i], 
    sigma_w = sigma_w, sigma_v = sigma_v
  )
  mu_filter[i + 1] <- kekka$mu_filter
  P_filter[i + 1] <- kekka$P_filter
  y_resid[i] <- kekka$y_resid
  F[i] <- kekka$F
  K[i] <- kekka$K
}

mu_filter
```

    ##   [1]    0.0000 1118.8812 1140.4103 1072.2709 1117.1955 1129.9866 1138.5439
    ##   [8] 1048.0302 1097.9501 1172.0492 1163.3531 1117.7658 1068.3295 1079.5944
    ##  [15] 1056.4625 1046.6101 1023.2095 1065.5697  993.5522  983.9474 1026.1063
    ##  [22] 1046.0692 1090.3562 1106.4694 1145.2451 1176.2469 1188.0670 1145.3642
    ##  [29] 1133.1088 1036.0933  983.1175  953.6387  883.4957  898.7607  880.9950
    ##  [36]  832.3683  854.9619  810.9367  867.4165  916.7425  930.8602  903.8824
    ##  [43]  855.8263  747.8108  768.3938  750.4571  850.2914  917.7517  894.5854
    ##  [50]  859.3069  848.9581  827.0867  831.9261  840.5911  846.3748  806.2904
    ##  [57]  816.7481  797.0947  796.7990  862.5012  834.5397  820.0756  832.2122
    ##  [64]  835.6669  864.9338  897.1003  897.0732  876.7917  912.7787  874.4763
    ##  [71]  820.8567  774.4286  793.7640  798.6906  783.3753  788.1367  856.1791
    ##  [78]  857.2114  861.7469  858.0331  866.6692  833.5293  810.6932  818.0703
    ##  [85]  880.7276  890.7969  916.5166  884.2285  894.7028  916.3956  889.0030
    ##  [92]  924.3926  919.4237  914.4465  983.4858  964.1735  905.2326  908.9519
    ##  [99]  857.3651  818.6341  797.3906

## 7-5.Rで実装するカルマンフィルタの対数尤度

-   最適なパラメータを求めるために、対数尤度を計算。
-   観測値の予測残差が期待値=0,分散=観測値の予測誤差分散の
    正規分布に従うことを利用する。

``` r
# 正規分布の確率密度を計算するdnorm
sum(log(dnorm(y_resid, mean = 0, sd=sqrt(F))))
```

    ## [1] -646.3254

## 7-6.Rで実装する最尤法

-   対数尤度を最大にするパラメタを求める。
-   sigma_w,sigma_vを引数とする関数を作成する。

``` r
log_likelihood <- function(sigma) {
  sigma_w <- exp(sigma[1])  # 分散は負にならないので自然対数をとる
  sigma_v <- exp(sigma[2])  # 分散は負にならないので自然対数をとる
  
  # 変数の定義
  N        <- length(Nile)        ; mu_filter   <- numeric(N)
  mu_zero  <- 0                   ; mu_filter   <- c(mu_zero, mu_filter)
  P_filter <- numeric(N)          ; P_zero      <- 10000000
  P_filter <- c(P_zero, P_filter) ; y_resid <- numeric(N)
  F        <- numeric(N)          ; K           <- numeric(N)

  # カルマンフィルタの実行
  for(i in 1:N) {
    kekka <- kfLocalLevel(
      y       = Nile[i],
      mu_pre  = mu_filter[i],
      P_pre   = P_filter[i],
      sigma_w = sigma_w,
      sigma_v = sigma_v
    )
    
    mu_filter[i+1] <- kekka$mu_filter
    P_filter[i+1]  <- kekka$P_filter
    y_resid[i] <- kekka$y_resid
    F[i]           <- kekka$F
    K[i]           <- kekka$K
  }
  
  return(1/2 * sum(log(F) + y_resid^2 /F))  # カルマンフィルタの対数尤度（ver.最小値問題）

}
```

-   最適化の計算には、optim関数を用いる。

``` r
best_sigma <- optim(log_likelihood, par=c(1,1), method="L-BFGS")

# 結果を確認。expをかませて、正の値へ。
exp(best_sigma$par)
```

    ## [1]  1468.461 15099.836

-   sigma_w=1468.461, sigma_v=15099.836が最適なパラメタとなる。

## 7-7.Rで実装する平滑化：関数を作る

-   平滑化はフィルタリングが終わった後に行う作業。
-   カルマンフィルタの結果（その他のフィルタリング）を用いて、「未来から過去へ」
    という順番で計算

``` r
smoothLocalLevel <- function(
    mu_filterd,
    P_filterd,
    r_post,
    s_post,
    F_post,
    y_resid_post,
    K_post) {
  
  # 状態平滑化漸化式
  r <- y_resid_post / F_post + (1 - K_post) * r_post
  mu_smooth <- mu_filterd + P_filter * r
  
  # 状態分散平滑化漸化式
  s <- 1/F_post + (1 - K_post)^2 * s_post
  P_smooth <- P_filterd - P_filterd^2 * s
  
  # 結果の格納
  result <- data.frame(
    mu_smooth = mu_smooth,  # 平滑化状態 
    P_smooth  = P_smooth,   # 平滑化状態分散(mu_smoothの分散)
    r = r,                  # 状態平滑化漸化式のパラメタ
    s = s                   # 状態分散平滑化漸化式のパラメタ
  )
  return(result)
}
```

-   ’\_post’と付いたら、「１時点未来の情報」であることを示す。

## 7-8.Rで実装する平滑化：状態を推定する

-   平滑化の結果を格納する箱を用意。

``` r
# 平滑化状態
mu_smooth <- numeric(N + 1)

# 平滑化状態分散
P_smooth  <- numeric(N + 1)

# 漸化式のパラメタ（初期値は0のままで）
r <- numeric(N)
s <- numeric(N)

# 最後のデータは、フィルタリングの結果とスムージングの結果が一致する
mu_smooth[N+1] <- mu_filter[N+1]
P_smooth[N+1]  <- P_filter[N+1]
```

-   for文で時点をずらしながら、平滑化関数を実行していく。
-   未来から過去へ計算が進んでいくことに注意

``` r
for(i in N:1){
  
  kekka <- smoothLocalLevel(
    mu_filterd = mu_filter[i],
    P_filterd  = P_filter[i],
    r_post = r[i],
    s_post = s[i],
    F_post = F[i],
    y_resid_post = y_resid[i],
    K_post = K[i]
    )
  
  mu_smooth[i] <- kekka$mu_smooth
  P_smooth[i]  <- kekka$P_smooth
  r[i-1] <- kekka$r
  s[i-1] <- kekka$s
}
```

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in r[i - 1] <- kekka$r: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in s[i - 1] <- kekka$s: number of items to replace is not a multiple of
    ## replacement length

    ## Warning in mu_smooth[i] <- kekka$mu_smooth: number of items to replace is not a
    ## multiple of replacement length

    ## Warning in P_smooth[i] <- kekka$P_smooth: number of items to replace is not a
    ## multiple of replacement length

``` r
mu_smooth
```

    ##   [1]    1111.3728   -6285.7896  -55520.7712   86488.4605   -9847.6247
    ##   [6]  -57312.3255 -110625.4913  171785.8683   54411.4454 -197607.4488
    ##  [11] -239587.0880 -160678.6625  -37953.7289  -94070.2998  -43736.2570
    ##  [16]  -23868.2067   53494.8138  -83829.2445  151242.8382  242402.2621
    ##  [21]  175755.2812  166559.0218   63938.3817   27574.3703 -106120.1884
    ##  [26] -260549.0644 -401169.6531 -392080.5369 -492283.5633 -315913.0171
    ##  [31] -237193.3422 -216267.8163  -37105.1001 -107655.8354  -82095.0610
    ##  [36]   67137.2466    8071.2625  173660.2897   28634.7570 -143621.1952
    ##  [41] -249366.1496 -242181.9005 -154327.3079  187949.0117  181074.0500
    ##  [46]  314191.1342   60770.0572 -166691.4172 -143004.4353  -65719.4675
    ##  [51]  -52067.4475    9281.4094   -5497.5906  -39905.7168  -76391.3550
    ##  [56]   43353.3657   20403.3360  100381.8540  138338.2056  -53885.3041
    ##  [61]   29322.7418   93393.1054   82747.3727  100284.4740   28792.2683
    ##  [66]  -79904.3044 -109713.2111  -75603.4006 -237085.3408 -183441.3824
    ##  [71]  -53244.3271   98553.4012   63194.7905   68061.8735  149635.0329
    ##  [76]  187113.4348    4287.6476    1737.9970  -14720.0718   -6744.5717
    ##  [81]  -41516.9823   65430.4660  173847.9118  210599.2926   56384.0758
    ##  [86]   39666.6060  -41157.6326   62752.7060   46892.6549  -16356.3825
    ##  [91]   78618.2168  -23571.4803  -14251.1231   -1447.8291 -257806.7459
    ##  [96] -282133.0376 -168808.6791 -245393.0514 -145662.9302  -56571.9827
    ## [101]     797.3906

## 7-9.dlmによるカルマンフィルタ

``` r
# dlmのパラメタの設定
model_dlm <- dlmModPoly(
  order = 1,     # ローカルレベルモデルを指定
  m0 = 0,        # 状態の初期値
  C0 = 10000000, # 状態の予測誤差の分散
  dW = sigma_w,
  dV = sigma_v
)

# カルマンフィルタの実行
mu_filter_dlm <- dlmFilter(Nile, model_dlm)
```

``` r
# フィルタ化推定量
mu_filter_dlm$m
```

    ## Time Series:
    ## Start = 1870 
    ## End = 1970 
    ## Frequency = 1 
    ##   [1]    0.0000 1118.8812 1140.4103 1072.2709 1117.1955 1129.9866 1138.5439
    ##   [8] 1048.0302 1097.9501 1172.0492 1163.3531 1117.7658 1068.3295 1079.5944
    ##  [15] 1056.4625 1046.6101 1023.2095 1065.5697  993.5522  983.9474 1026.1063
    ##  [22] 1046.0692 1090.3562 1106.4694 1145.2451 1176.2469 1188.0670 1145.3642
    ##  [29] 1133.1088 1036.0933  983.1175  953.6387  883.4957  898.7607  880.9950
    ##  [36]  832.3683  854.9619  810.9367  867.4165  916.7425  930.8602  903.8824
    ##  [43]  855.8263  747.8108  768.3938  750.4571  850.2914  917.7517  894.5854
    ##  [50]  859.3069  848.9581  827.0867  831.9261  840.5911  846.3748  806.2904
    ##  [57]  816.7481  797.0947  796.7990  862.5012  834.5397  820.0756  832.2122
    ##  [64]  835.6669  864.9338  897.1003  897.0732  876.7917  912.7787  874.4763
    ##  [71]  820.8567  774.4286  793.7640  798.6906  783.3753  788.1367  856.1791
    ##  [78]  857.2114  861.7469  858.0331  866.6692  833.5293  810.6932  818.0703
    ##  [85]  880.7276  890.7969  916.5166  884.2285  894.7028  916.3956  889.0030
    ##  [92]  924.3926  919.4237  914.4465  983.4858  964.1735  905.2326  908.9519
    ##  [99]  857.3651  818.6341  797.3906

``` r
mu_filter
```

    ##   [1]    0.0000 1118.8812 1140.4103 1072.2709 1117.1955 1129.9866 1138.5439
    ##   [8] 1048.0302 1097.9501 1172.0492 1163.3531 1117.7658 1068.3295 1079.5944
    ##  [15] 1056.4625 1046.6101 1023.2095 1065.5697  993.5522  983.9474 1026.1063
    ##  [22] 1046.0692 1090.3562 1106.4694 1145.2451 1176.2469 1188.0670 1145.3642
    ##  [29] 1133.1088 1036.0933  983.1175  953.6387  883.4957  898.7607  880.9950
    ##  [36]  832.3683  854.9619  810.9367  867.4165  916.7425  930.8602  903.8824
    ##  [43]  855.8263  747.8108  768.3938  750.4571  850.2914  917.7517  894.5854
    ##  [50]  859.3069  848.9581  827.0867  831.9261  840.5911  846.3748  806.2904
    ##  [57]  816.7481  797.0947  796.7990  862.5012  834.5397  820.0756  832.2122
    ##  [64]  835.6669  864.9338  897.1003  897.0732  876.7917  912.7787  874.4763
    ##  [71]  820.8567  774.4286  793.7640  798.6906  783.3753  788.1367  856.1791
    ##  [78]  857.2114  861.7469  858.0331  866.6692  833.5293  810.6932  818.0703
    ##  [85]  880.7276  890.7969  916.5166  884.2285  894.7028  916.3956  889.0030
    ##  [92]  924.3926  919.4237  914.4465  983.4858  964.1735  905.2326  908.9519
    ##  [99]  857.3651  818.6341  797.3906

``` r
sum((mu_filter_dlm$m[-1] - mu_filter[-1])^2)  # スクラッチとdlmの結果の確認
```

    ## [1] 1.279545e-24

## 7-10.dlmによる対数尤度の計算

``` r
# 対数尤度の指標
dlmLL(Nile, model_dlm)
```

    ## [1] 554.4316

``` r
# 比較
1/2 * sum(log(F) + y_resid^2 / F)
```

    ## [1] 554.4316

## 7-11.dlmによる平滑化

``` r
# dlmSmooth()の引数にモデルを与えることで平滑化状態を推定
mu_smooth_dlm <- dlmSmooth(mu_filter_dlm)

# 結果の確認
mu_smooth_dlm$s
```

    ## Time Series:
    ## Start = 1870 
    ## End = 1970 
    ## Frequency = 1 
    ##   [1] 1111.3728 1111.4840 1110.7435 1105.0774 1113.6190 1112.5225 1106.6783
    ##   [8] 1095.5019 1112.5757 1117.9070 1098.0291 1073.9540 1057.7744 1053.8722
    ##  [15] 1044.3572 1039.8779 1037.3864 1042.6336 1034.1441 1049.1690 1073.3109
    ##  [22] 1090.7838 1107.3351 1113.6199 1116.2667 1105.5401 1079.3676 1039.1318
    ##  [29]  999.8092  950.4676  918.7727  894.9550  873.2329  869.4340  858.5785
    ##  [36]  850.2809  856.9114  857.6331  874.9180  877.6947  863.2409  838.2112
    ##  [43]  813.9026  798.3843  817.1045  835.1350  866.4791  872.4711  855.7101
    ##  [50]  841.3202  834.6624  829.3707  830.2162  829.5832  825.5086  817.7848
    ##  [57]  822.0395  823.9982  833.9566  847.7108  842.2360  845.0848  854.3421
    ##  [64]  862.5336  872.4785  875.2713  867.1911  856.1301  848.4821  824.6823
    ##  [71]  806.2507  800.8442  810.6221  816.8622  823.5885  838.4736  857.1062
    ##  [78]  857.4493  857.5374  855.9792  855.2190  850.9806  857.4403  874.7440
    ##  [85]  895.7221  901.2725  905.1500  900.9426  907.1295  911.7293  910.0020
    ##  [92]  917.7749  915.3253  913.8083  913.5720  887.6930  859.3833  842.4119
    ##  [99]  817.7817  803.1297  797.3906

``` r
# スクラッチの場合
mu_smooth
```

    ##   [1]    1111.3728   -6285.7896  -55520.7712   86488.4605   -9847.6247
    ##   [6]  -57312.3255 -110625.4913  171785.8683   54411.4454 -197607.4488
    ##  [11] -239587.0880 -160678.6625  -37953.7289  -94070.2998  -43736.2570
    ##  [16]  -23868.2067   53494.8138  -83829.2445  151242.8382  242402.2621
    ##  [21]  175755.2812  166559.0218   63938.3817   27574.3703 -106120.1884
    ##  [26] -260549.0644 -401169.6531 -392080.5369 -492283.5633 -315913.0171
    ##  [31] -237193.3422 -216267.8163  -37105.1001 -107655.8354  -82095.0610
    ##  [36]   67137.2466    8071.2625  173660.2897   28634.7570 -143621.1952
    ##  [41] -249366.1496 -242181.9005 -154327.3079  187949.0117  181074.0500
    ##  [46]  314191.1342   60770.0572 -166691.4172 -143004.4353  -65719.4675
    ##  [51]  -52067.4475    9281.4094   -5497.5906  -39905.7168  -76391.3550
    ##  [56]   43353.3657   20403.3360  100381.8540  138338.2056  -53885.3041
    ##  [61]   29322.7418   93393.1054   82747.3727  100284.4740   28792.2683
    ##  [66]  -79904.3044 -109713.2111  -75603.4006 -237085.3408 -183441.3824
    ##  [71]  -53244.3271   98553.4012   63194.7905   68061.8735  149635.0329
    ##  [76]  187113.4348    4287.6476    1737.9970  -14720.0718   -6744.5717
    ##  [81]  -41516.9823   65430.4660  173847.9118  210599.2926   56384.0758
    ##  [86]   39666.6060  -41157.6326   62752.7060   46892.6549  -16356.3825
    ##  [91]   78618.2168  -23571.4803  -14251.1231   -1447.8291 -257806.7459
    ##  [96] -282133.0376 -168808.6791 -245393.0514 -145662.9302  -56571.9827
    ## [101]     797.3906

``` r
# 比較
sum((mu_smooth_dlm$s - mu_smooth)^2)
```

    ## [1] 2.261882e+12

## 7-12.参考：dlmの使い方

``` r
# Step1 モデルの構造を決める
build_local_level_dlm <- function(theta){
  dlmModPoly(order = 1, dV = exp(theta[1]), dW = exp(theta[2]))
}

# Step2 パラメタ推定
par_local_level_dlm <- dlmMLE(Nile, parm = c(1,1), build_local_level_dlm)

# 推定された分散を使って、モデルを組み直す
fit_local_level_dlm <- build_local_level_dlm(par_local_level_dlm$par)

# Step3 フィルタリング
filter_local_level_dlm <- dlmFilter(Nile, fit_local_level_dlm)

# Step4 スムージング
smooth_local_level_dlm <- dlmSmooth(filter_local_level_dlm)
```

-   Step1 モデルの構造を決める
    状態方程式・観測方程式によりモデルを表す。
    最尤法を実装時と同じように、「パラメタを引数にした関数」を作成。
    最適なパラメタを推定するのが簡単。

    -   dlmModPoly order=1:ローカルレベルモデル
        order=2:ローカル線形トレンドモデル

    -   dlmModSeas
        ダミー変数を用いた季節変動を入れたモデルを組むことが可能

    -   dlmModTrig
        三角関数を用いた季節変動を入れたモデルを組むことが可能。

    -   dlmModReg
        外生変数を組み込むことが可能。時変係数のモデルにも対応。

    -   dlmModARMA ARMAモデルと同等のモデルを推定可能。

-   Step2 パラメタ推定
    dlmMLE関数を用いることで最尤法によるパラメタ推定が可能
    “par_local_level_dlm$par”に推定されたパラメタが格納されている。

-   Step3 フィルタリング dlmFilter関数を用いることでフィルタリング

-   Step4 スムージング dlmSmooth関数を用いることで平滑化状態を推定

## 7-13.Rで実装する散漫カルマンフィルタ

``` r
# 状態の推定値
mu_diffuse_filter <- numeric(N+1)

# 状態の予測誤差の分散
P_diffuse_filter <- numeric(N+1)

# 散漫初期化を用いると、１時点目のフィルタ化推定量は以下のようになる
mu_diffuse_filter[2] <- Nile[1]
P_diffuse_filter[2]  <- sigma_v

# 観測値の予測残差
y_resid_diffuse <- numeric(N)

# 観測値の予測誤差の分散
F_diffuse <- numeric(N)

# カルマンゲイン
K_diffuse <- numeric(N)
```

-   カルマンフィルタと同様、時点をずらしながらフィルタリングと予測を実行
-   散漫初期化が行われているため、２時点目からフィルタリングを行なっている。

``` r
for(i in 2:N){
  kekka <- kfLocalLevel(
    y=Nile[i],
    mu_pre = mu_diffuse_filter[i],
    P_pre  = P_diffuse_filter[i],
    sigma_w = sigma_w,
    sigma_v = sigma_v
  )
  
  mu_diffuse_filter[i+1] <- kekka$mu_filter
  P_diffuse_filter[i+1]  <- kekka$P_filter
  y_resid_diffuse[i]     <- kekka$y_resid
  F_diffuse[i]           <- kekka$F
  K_diffuse[i]           <- kekka$K
}
```

-   通常のカルマンフィルタとの結果を比較する。
-   古い時点において、多少値が変わるはず。

``` r
# 散漫カルマンフィルタ
mu_diffuse_filter
```

    ##   [1]    0.0000 1120.0000 1140.9524 1072.5894 1117.4155 1130.1417 1138.6551
    ##   [8] 1048.1088 1098.0076 1172.0914 1163.3839 1117.7882 1068.3457 1079.6063
    ##  [15] 1056.4711 1046.6164 1023.2141 1065.5730  993.5546  983.9492 1026.1076
    ##  [22] 1046.0702 1090.3569 1106.4699 1145.2455 1176.2471 1188.0672 1145.3644
    ##  [29] 1133.1089 1036.0934  983.1176  953.6388  883.4957  898.7607  880.9951
    ##  [36]  832.3683  854.9619  810.9367  867.4165  916.7425  930.8602  903.8824
    ##  [43]  855.8263  747.8108  768.3938  750.4571  850.2914  917.7517  894.5854
    ##  [50]  859.3069  848.9581  827.0867  831.9261  840.5911  846.3748  806.2904
    ##  [57]  816.7481  797.0947  796.7990  862.5012  834.5397  820.0756  832.2122
    ##  [64]  835.6669  864.9338  897.1003  897.0732  876.7917  912.7787  874.4763
    ##  [71]  820.8567  774.4286  793.7640  798.6906  783.3753  788.1367  856.1791
    ##  [78]  857.2114  861.7469  858.0331  866.6692  833.5293  810.6932  818.0703
    ##  [85]  880.7276  890.7969  916.5166  884.2285  894.7028  916.3956  889.0030
    ##  [92]  924.3926  919.4237  914.4465  983.4858  964.1735  905.2326  908.9519
    ##  [99]  857.3651  818.6341  797.3906

``` r
# 通常のカルマンフィルタ
mu_filter
```

    ##   [1]    0.0000 1118.8812 1140.4103 1072.2709 1117.1955 1129.9866 1138.5439
    ##   [8] 1048.0302 1097.9501 1172.0492 1163.3531 1117.7658 1068.3295 1079.5944
    ##  [15] 1056.4625 1046.6101 1023.2095 1065.5697  993.5522  983.9474 1026.1063
    ##  [22] 1046.0692 1090.3562 1106.4694 1145.2451 1176.2469 1188.0670 1145.3642
    ##  [29] 1133.1088 1036.0933  983.1175  953.6387  883.4957  898.7607  880.9950
    ##  [36]  832.3683  854.9619  810.9367  867.4165  916.7425  930.8602  903.8824
    ##  [43]  855.8263  747.8108  768.3938  750.4571  850.2914  917.7517  894.5854
    ##  [50]  859.3069  848.9581  827.0867  831.9261  840.5911  846.3748  806.2904
    ##  [57]  816.7481  797.0947  796.7990  862.5012  834.5397  820.0756  832.2122
    ##  [64]  835.6669  864.9338  897.1003  897.0732  876.7917  912.7787  874.4763
    ##  [71]  820.8567  774.4286  793.7640  798.6906  783.3753  788.1367  856.1791
    ##  [78]  857.2114  861.7469  858.0331  866.6692  833.5293  810.6932  818.0703
    ##  [85]  880.7276  890.7969  916.5166  884.2285  894.7028  916.3956  889.0030
    ##  [92]  924.3926  919.4237  914.4465  983.4858  964.1735  905.2326  908.9519
    ##  [99]  857.3651  818.6341  797.3906

## 7-14.Rで実装する散漫対数尤度

``` r
# dnorm関数を使った対数尤度の計算
sum(
  log(
    dnorm(y_resid_diffuse[-1], mean = 0, sd = sqrt(F_diffuse[-1]))
  )
)
```

    ## [1] -637.2855

``` r
# 対数尤度の計算２
-1 * ((N -1)/2) * log(2*pi) - 1/2*sum(log(F_diffuse[-1]) + y_resid_diffuse[-1]^2 / F_diffuse[-1])
```

    ## [1] -637.2855

-   \[-1\]とすることで、１時点目のデータを省いている。

## 7-15.KFASによる散漫カルマンフィルタ

``` r
# KFASのパラメタの設定
model_kfas <- SSModel(
  H = sigma_v,
  Nile ~ SSMtrend(degree = 1, Q = sigma_w)
)

# 散漫カルマンフィルタの実行
mu_filter_kfas <- KFS(
  model_kfas,
  filtering = c("state", "mean"),
  smoothing = "none"
)

# スクラッチと比較
sum((mu_filter_kfas$a - mu_diffuse_filter)^2)
```

    ## [1] 2.584939e-25

## 7-16.KFASによる散漫対数尤度の計算

``` r
logLik(model_kfas)
```

    ## [1] -637.2855

## 7-17.dlmとKFASの比較とKFASの優位性

-   KFASの優れている点
    -   散漫カルマンフィルタに対応している。
    -   計算速度が速い（特にパラメタ推定にかかる時間が短い）
    -   線形非ガウシアンなデータでもモデル化が可能。
